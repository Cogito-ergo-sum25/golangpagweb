{{template "base" .}}
{{define "content"}}
<div class="container mt-4">
    <h2><i class="fa-regular fa-calendar"></i> Calendario de Licitaciones</h2>
    <div id="calendar"></div>
</div>

<style>
/* Estilo base para el d√≠a actual */
.fc .fc-day-today {
    background-color: #fff3cd !important; /* amarillo suave */
    border: 2px solid #ffc107;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(255, 193, 7, 0.4);
    position: relative;
    animation: pulse-border 1.2s ease-in-out;
}

/* Vista semanal/diaria tambi√©n */
.fc .fc-timegrid-col.fc-day-today,
.fc .fc-daygrid-day.fc-day-today {
    background-color: #fff3cd !important;
    border: 2px solid #ffc107;
    box-shadow: inset 0 0 8px rgba(255, 193, 7, 0.25);
    border-radius: 10px;
    position: relative;
    animation: pulse-border 1.2s ease-in-out;
}

/* √çcono üìÖ en la esquina superior derecha */
.fc .fc-day-today::after {
    content: "üìÖ";
    position: absolute;
    top: 6px;
    right: 150px;
    font-size: 1rem;
    pointer-events: none;
}

/* üåô Estilos especiales para el d√≠a actual en modo oscuro */
    /* Estilos generales */
    .dark-mode .fc { color: #e0e0e0; }
    .dark-mode .fc-theme-standard th, .dark-mode .fc-theme-standard td { border-color: #404040; }
    .dark-mode .fc-view-harness { background-color: #1e1e1e; }
    .dark-mode .fc-col-header-cell-cushion { color: #bb86fc; font-weight: bold; }
    .dark-mode .fc-button { background-color: #333 !important; color: #f1f1f1 !important; border-color: #555 !important; }
    .dark-mode .fc .fc-day-today { background-color: #3b3b3b !important; border: 2px solid #ffc107; }

    /* Estilos para la vista multiMonthYear */
    .dark-mode .fc-multimonth-month .fc-scrollgrid { background-color: #1e1e1e; border: none; }
    .dark-mode .fc-multimonth-title { color: #e0e0e0 !important; }

    body.dark-mode .fc-daygrid-day {
        background: #1e1e1e !important;
    }
    body.dark-mode .fc-daygrid-day-bg {
        background: #1e1e1e !important;
    }

    /* ======================================================= */
    /* === ¬°AQU√ç EST√Å LA SOLUCI√ìN PARA EL POPOVER DE EVENTOS! === */
    /* ======================================================= */
    .dark-mode .fc-popover {
        background-color: #2c2c2e; /* Fondo oscuro para el popover */
        border: 1px solid #444;    /* Borde oscuro */
    }

    .dark-mode .fc-popover-header {
        background-color: #333;      /* Fondo un poco m√°s oscuro para la cabecera */
        color: #f1f1f1;             /* Texto claro para la fecha */
        border-bottom-color: #444; /* Borde inferior oscuro */
    }

    .dark-mode .fc-popover-close {
        color: #ccc; /* Color claro para el √≠cono de cerrar 'x' */
    }
    
    .dark-mode .fc-popover-body {
        background-color: #2c2c2e; /* Aseguramos que el cuerpo tambi√©n sea oscuro */
    }
    /* ======================================================= */
    /* =================== FIN DE LA SOLUCI√ìN =================== */
    /* ======================================================= */

</style>

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.css" rel="stylesheet" />

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.js"></script>

<script>
    // ... Tu JavaScript existente (no necesita cambios) ...
    document.addEventListener('DOMContentLoaded', function () {
        // Parse eventos JSON seguro
        const eventos = JSON.parse('{{ toJson .Data.Eventos }}');
        console.log("Eventos desde Go (parsed):", eventos);

        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            firstDay: 1,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'multiMonthYear,dayGridMonth,listWeek'
            },
            buttonText: {
                today: 'Hoy',
                year:  'A√±o', 
                month: 'Mes',
                list: 'Agenda Semanal',
            },
            events: eventos,
            eventClick: function(info) {
                const props = info.event.extendedProps;
                const eventDate = new Date(info.event.start);
                const today = new Date();
                const diffTime = eventDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let tiempoRestante = "";
                    if (diffDays > 0) {
                        tiempoRestante = `
                            <div class="alert alert-info d-flex align-items-center gap-2 mb-2" role="alert">
                                ‚è≥ <div>Faltan <strong>${diffDays}</strong> d√≠a(s)</div>
                            </div>`;
                    } else if (diffDays === 0) {
                        tiempoRestante = `
                            <div class="alert alert-warning d-flex align-items-center gap-2 mb-2" role="alert">
                                üìÖ <div><strong>¬°Es hoy!</strong> Este evento ocurre hoy.</div>
                            </div>`;
                    } else {
                        tiempoRestante = `
                            <div class="alert alert-secondary d-flex align-items-center gap-2 mb-2" role="alert">
                                üïì <div>Ocurri√≥ hace <strong>${Math.abs(diffDays)}</strong> d√≠a(s)</div>
                            </div>`;
                    }
                const content = `
                    <div class="text-start">
                        <h5 class="mb-2">${info.event.title}</h5>
                        <p><b>No. Contrataci√≥n:</b> ${props.num}<br>
                        <b>Tipo:</b> ${props.tipo}<br>
                        <b>Estatus:</b> ${props.estatus}<br>
                        <b>Fecha:</b> ${eventDate.toLocaleDateString('es-MX')}<br>
                        ${tiempoRestante}</p>
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="/editar-licitacion/${props.id}" class="btn btn-sm amarillo">Editar</a>
                            <a href="/mostrar-partidas/${props.id}" class="btn btn-sm azul">Partidas</a>
                        </div>
                    </div>
                `;
                Swal.fire({
                    html: content,
                    showConfirmButton: false,
                    width: 500
                });
            }
        });

        calendar.render();
    });
</script>
{{end}}